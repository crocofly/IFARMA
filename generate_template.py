"""
generate_template.py — Создаёт шаблон синопсиса в формате .docx.

Шаблон содержит таблицу из 29 строк в соответствии со структурой
документа "шаблон_для_заполнения.docx".
"""

from docx import Document
from docx.shared import Pt, Inches, RGBColor, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.table import WD_TABLE_ALIGNMENT
import copy


def create_synopsis_template(output_path: str = "data/шаблон_для_заполнения.docx"):
    doc = Document()

    # Page settings
    section = doc.sections[0]
    section.page_width = Cm(21)
    section.page_height = Cm(29.7)
    section.left_margin = Cm(2)
    section.right_margin = Cm(1.5)
    section.top_margin = Cm(2)
    section.bottom_margin = Cm(1.5)

    # Стиль по умолчанию
    style = doc.styles["Normal"]
    style.font.name = "Times New Roman"
    style.font.size = Pt(11)

    # Заголовок
    title = doc.add_paragraph()
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = title.add_run("СИНОПСИС ПРОТОКОЛА")
    run.bold = True
    run.font.size = Pt(14)
    run.font.name = "Times New Roman"

    # Создаём таблицу 29 строк × 2 столбца
    # Каждая строка: [Название поля | Содержимое]
    rows_data = [
        # Row 0: Название протокола
        ("Название протокола:", ""),
        # Row 1: Идентификационный номер
        ("Идентификационный номер протокола:", ""),
        # Row 2: Спонсор
        ("Спонсор исследования:", ""),
        # Row 3: Исследовательский центр
        ("Исследовательский центр:", ""),
        # Row 4: Биоаналитическая лаборатория
        ("Биоаналитическая лаборатория:", ""),
        # Row 5: Фаза
        ("Фаза клинического исследования:", "Исследование биоэквивалентности"),
        # Row 6: Название исследуемого препарата
        ("Название исследуемого препарата:", ""),
        # Row 7: Действующее вещество
        ("Действующее вещество:", ""),
        # Row 8: Цель исследования
        ("Цель исследования:", (
            "Основная цель:\n"
            "Оценка сравнительной фармакокинетики и биоэквивалентности препаратов "
            "          и           натощак/после приема высококалорийной пищи "
            "у здоровых добровольцев.\n\n"
            "Дополнительная цель:\n"
            "Оценка безопасности и переносимости препаратов "
            "          и           у здоровых добровольцев."
        )),
        # Row 9: Задачи исследования
        ("Задачи исследования:", (
            "Определить концентрацию           в плазме крови добровольцев после "
            "однократного приема препаратов          ."
        )),
        # Row 10: Этические и регуляторные аспекты
        ("Этические и регуляторные аспекты:", (
            "Исследование будет проводиться согласно Протоколу, в строгом соответствии с:\n"
            "- Конституцией Российской Федерации;\n"
            "- Этическими принципами Хельсинкской декларации ВМА 1964 г. "
            "в последней редакции, принятой на 75-ой Генеральной Ассамблее ВМА, "
            "Хельсинки, Финляндия, октябрь 2024 г;\n"
            "- Решением Совета ЕЭК от 03.11.2016 № 79 (GCP);\n"
            "- Решением Совета ЕЭК от 03.11.2016 № 85 (БЭ);\n"
            "а также в соответствии с применимыми требованиями законодательства РФ.\n\n"
            "Страхование жизни и здоровья добровольцев осуществляется компанией          ."
        )),
        # Row 11: Методология исследования
        ("Методология исследования:", (
            "Открытое рандомизированное исследование в перекрёстном дизайне.\n\n"
            "Добровольцы будут распределены в соответствии с рандомизационным списком "
            "в одну из двух групп в соотношении 1:1:\n\n"
            "Группа 1 (n=ХХ) (T/R): Период 1 — однократно натощак [T], "
            "Период 2 — однократно натощак [R]\n"
            "Группа 2 (n=ХХ) (R/T): Период 1 — однократно натощак [R], "
            "Период 2 — однократно натощак [T]\n\n"
            "Период скрининга:      дней.\n"
            "Период ФК исследования:      дней.\n"
            "Отмывочный период:      дней.\n"
            "Период последующего наблюдения:      дней.\n\n"
            "В каждую группу будет включено по      добровольцев. "
            "В каждом периоде добровольцы получат исследуемый/референтный препарат "
            "по схеме в соответствии с группой.\n\n"
            "Отбор образцов крови:\n"
            "В каждом периоде будет отобрано по      образцов крови.\n"
            "Объём одного образца — 5 мл.\n"
            "Общий объём крови за период:      мл.\n"
            "Всего образцов за      периода:      .\n"
            "Суммарный объём крови:      мл.\n\n"
            "Отмывочный период:\n"
            "Отмывочный период составит не менее      дней "
            "(≥ 5 × T½           =      ч, что соответствует      дням).\n\n"
            "Период последующего наблюдения:      дней."
        )),
        # Row 12: Количество добровольцев
        ("Количество добровольцев:", (
            "На основании имеющихся литературных данных о внутрииндивидуальной "
            "вариабельности (CVintra =      %) для AUC и/или Cmax, "
            "размер выборки рассчитан при мощности 80% и α = 0.05.\n\n"
            "Расчётное количество добровольцев:      чел.\n"
            "С учётом скрининга:      чел."
        )),
        # Row 13: Критерии включения
        ("Критерии включения:", ""),
        # Row 14: Критерии невключения
        ("Критерии невключения:", ""),
        # Row 15: Критерии исключения
        ("Критерии исключения:", (
            "Добровольцы, включенные в исследование, могут быть исключены из него "
            "при наступлении любого из следующих событий:\n"
            "1. Отзыв информированного согласия.\n"
            "2. Решение Исследователя об исключении в интересах безопасности.\n"
            "3. Возникновение серьёзного нежелательного явления.\n"
            "4. Нарушение протокола.\n"
            "5. Административные причины."
        )),
        # Row 16: Исследуемый препарат
        ("Исследуемый препарат:", (
            "Торговое наименование:          \n"
            "Лекарственная форма:          \n"
            "Дозировка:          \n\n"
            "Состав на 1          :\n"
            "Действующее вещество:          \n"
            "Вспомогательные вещества:          \n\n"
            "Способ применения: внутрь, по 1          препарата          .\n"
            "День приёма: День     , День     .\n"
            "Условия хранения:          \n"
            "Производитель:          "
        )),
        # Row 17: Референтный (оригинальный) препарат
        ("Препарат сравнения (референтный):", (
            "Торговое наименование:          \n"
            "МНН:          \n"
            "Лекарственная форма:          \n"
            "Дозировка:          \n\n"
            "Состав на 1          :\n"
            "Действующее вещество:          \n"
            "Вспомогательные вещества:          \n\n"
            "Способ применения: внутрь, по 1          препарата          .\n"
            "День приёма: День     , День     .\n"
            "Условия хранения:          \n"
            "Производитель:          \n\n"
            "Оригинальный препарат:          \n"
            "РУ ЛП:          \n"
            "Лекарственная форма:          "
        )),
        # Row 18: Способ применения
        ("Способ применения:", (
            "Препараты применяются перорально, однократно, натощак, "
            "после ночного голодания не менее 10 часов, запивая 200 ± 10 мл воды."
        )),
        # Row 19: Рандомизация
        ("Рандомизация:", (
            "Рандомизация будет проведена с использованием валидированной "
            "компьютерной программы генерации случайных чисел. "
            "Список рандомизации будет сформирован до начала исследования."
        )),
        # Row 20: Фармакокинетические параметры
        ("Фармакокинетические параметры:", (
            "Первичные ФК параметры (для оценки биоэквивалентности):\n"
            "- AUC₀₋ₜ (площадь под кривой «концентрация           — время»)\n"
            "- Cmax (максимальная концентрация           в плазме крови)\n\n"
            "Вторичные ФК параметры:\n"
            "- AUC₀₋∞\n"
            "- Tmax\n"
            "- T½\n"
            "- Kel"
        )),
        # Row 21: Аналитический метод
        ("Аналитический метод:", (
            "Определение концентрации           в плазме крови будет проводиться "
            "валидированным биоаналитическим методом (ЖХ-МС/МС) "
            "в соответствии с действующими руководствами."
        )),
        # Row 22: Критерии биоэквивалентности
        ("Критерии биоэквивалентности:", ""),
        # Row 23: Статистический анализ
        ("Статистический анализ:", (
            "Статистическая обработка ФК параметров будет проведена с использованием "
            "дисперсионного анализа (ANOVA) для логарифмически преобразованных данных. "
            "90% доверительные интервалы для отношений средних геометрических значений "
            "Test/Reference будут рассчитаны для AUC₀₋ₜ и Cmax."
        )),
        # Row 24: Расчёт размера выборки
        ("Расчёт размера выборки:", ""),
        # Row 25: Безопасность
        ("Оценка безопасности:", (
            "Все добровольцы, получившие хотя бы одну дозу исследуемого препарата, "
            "будут включены в популяцию для анализа безопасности. "
            "Параметры безопасности будут анализироваться при помощи описательной статистики. "
            "Все НЯ будут зафиксированы и классифицированы по MedDRA."
        )),
        # Row 26: Заслепление
        ("Заслепление:", (
            "Открытое исследование — заслепление не предусмотрено. "
            "Биоаналитическая часть проводится заслеплённо.\n"
            "По      добровольцев в группу."
        )),
        # Row 27: Список источников
        ("Список источников:", ""),
        # Row 28: Версия протокола
        ("Номер версии протокола:", ""),
    ]

    table = doc.add_table(rows=len(rows_data), cols=2)
    table.style = "Table Grid"
    table.alignment = WD_TABLE_ALIGNMENT.CENTER

    for i, (label, content) in enumerate(rows_data):
        row = table.rows[i]
        # Left cell - label (bold)
        cell_label = row.cells[0]
        cell_label.text = ""
        p = cell_label.paragraphs[0]
        run = p.add_run(label)
        run.bold = True
        run.font.name = "Times New Roman"
        run.font.size = Pt(10)

        # Right cell - content
        cell_content = row.cells[1]
        cell_content.text = ""
        if content:
            for j, line in enumerate(content.split("\n")):
                if j == 0:
                    p = cell_content.paragraphs[0]
                else:
                    p = cell_content.add_paragraph()
                run = p.add_run(line)
                run.font.name = "Times New Roman"
                run.font.size = Pt(10)

    # Set column widths
    for row in table.rows:
        row.cells[0].width = Cm(5)
        row.cells[1].width = Cm(13)

    doc.save(output_path)
    print(f"✅ Шаблон создан: {output_path}")
    return output_path


if __name__ == "__main__":
    create_synopsis_template()
