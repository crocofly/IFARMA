"""
criteria_generator.py — Генератор критериев включения/невключения/исключения.

Полностью детерминированный (без LLM).
Стандартные формулировки из шаблона синопсиса + динамические вставки.

Динамические поля:
  - Включение: возраст, пол, контрацепция (период = f(T½)), алкоголь
  - Невключение: название препарата, котинин, лактоза, беременность (если женщины)
  - Исключение: п.8 рвота/диарея = ceil(2×Tmax), п.11 беременность (если женщины)
"""

import math
from typing import Optional


def generate_inclusion_criteria(
    sex: str = "males_only",
    age_min: int = 18,
    age_max: int = 45,
    t_half_hours: Optional[float] = None,
    alcohol_abstain_hours: int = 72,
) -> str:
    """
    Генерирует текст критериев включения.

    Args:
        sex: "males_only" | "males_and_females"
        age_min: нижняя граница возраста (стандарт 18)
        age_max: верхняя граница возраста (стандарт 45)
        t_half_hours: период полувыведения (часы), для расчёта контрацепции
        alcohol_abstain_hours: часы отказа от алкоголя до скрининга (стандарт 72)
    """
    include_women = (sex == "males_and_females")

    # Пол в формулировке
    if include_women:
        sex_text = "Некурящие мужчины и женщины"
        weight_text = (
            "при массе тела более 45 кг для женщин "
            "и более 55 кг для мужчин и не более 110 кг"
        )
    else:
        sex_text = "Некурящие мужчины"
        weight_text = "при массе тела более 55 кг и не более 110 кг"

    # Контрацепция — период после исследования
    if t_half_hours and t_half_hours > 0:
        # Стандарт: 5 × T½ → округлить до целого месяца вверх
        elimination_days = math.ceil(5 * t_half_hours / 24)
        contraception_months = max(1, math.ceil(elimination_days / 30))
    else:
        contraception_months = 1  # по умолчанию 1 месяц

    if contraception_months == 1:
        contraception_period = "в течение 1 месяца после его окончания"
    else:
        contraception_period = f"в течение {contraception_months} месяцев после его окончания"

    # Методы контрацепции
    if include_women:
        contraception_methods = (
            "К адекватным методам контрацепции относятся: "
            "воздержание от половых контактов, кроме того, "
            "для мужчин: презерватив со спермицидом (пена, гель, крем), "
            "для женщин: презерватив (для партнера), диафрагма или шеечный "
            "колпачок со спермицидом, внутриматочная спираль."
        )
    else:
        contraception_methods = (
            "К адекватным методам контрацепции относятся: "
            "воздержание от половых контактов, "
            "презерватив со спермицидом (пена, гель, крем)."
        )

    items = [
        "Подписанная письменная форма информированного согласия до начала "
        "каких-либо процедур скрининга, а также способность, по мнению "
        "Исследователя, следовать всем требованиям Протокола.",

        f"{sex_text} в возрасте от {age_min} до {age_max} лет включительно "
        "на момент подписания формы Информированного согласия.",

        "Верифицированный диагноз «здоров» по данным стандартных клинических, "
        "лабораторных и инструментальных методов обследования.",

        f"Индекс массы тела (ИМТ) от 18,5 до 30,0 кг/м², {weight_text}.",

        "Уровень артериального давления (АД): систолическое артериальное "
        "давление (САД) от 100 до 129 мм рт. ст. (включительно), "
        "диастолическое артериальное давление (ДАД) от 60 до 89 мм рт. ст. "
        "(включительно).",

        "Частота сердечных сокращений (ЧСС) от 60 до 89 ударов в 1 минуту "
        "(включительно).",

        "Частота дыхательных движений (ЧДД) от 12 до 20 в 1 минуту "
        "(включительно).",

        "Температура тела от 36°C до 36,9°C (включительно).",

        f"Отказ от приема алкоголя в течение {alcohol_abstain_hours} часов "
        "до начала каких-либо процедур скрининга и в течение всего исследования.",

        "Согласие добровольца на использование надежных методов контрацепции "
        f"на протяжении всего исследования и {contraception_period}. "
        f"{contraception_methods}",
    ]

    header = (
        "Для включения в исследование добровольцы должны соответствовать "
        "всем следующим критериям включения:"
    )
    numbered = "\n".join(f"{i+1}.\t{item}" for i, item in enumerate(items))
    return f"{header}\n{numbered}"


def generate_non_inclusion_criteria(
    sex: str = "males_only",
    inn_ru: str = "",
    include_cotinine: bool = True,
    include_lactose: bool = True,
) -> str:
    """
    Генерирует текст критериев невключения.

    Args:
        sex: "males_only" | "males_and_females"
        inn_ru: МНН для п.18 (гиперчувствительность)
        include_cotinine: включать тест на котинин (для некурящих)
        include_lactose: включать непереносимость лактозы
    """
    include_women = (sex == "males_and_females")

    items = [
        # 1
        "Наличие в анамнезе острых или хронических заболеваний "
        "сердечно-сосудистой, дыхательной, нервной, эндокринной, "
        "опорно-двигательной, кроветворной и иммунной систем, почек "
        "и мочевыводящих путей, печени и желчевыводящих путей, "
        "желудочно-кишечного тракта (ЖКТ), кожи, а также "
        "доброкачественных опухолевых и онкологических заболеваний.",
        # 2
        "Хирургические вмешательства на ЖКТ в анамнезе "
        "(за исключением аппендэктомии не менее, чем за 1 год до скрининга).",
        # 3
        "Заболевания/состояния, которые, по мнению исследователя, могут "
        "повлиять на абсорбцию, распределение, метаболизм или экскрецию "
        "исследуемых лекарственных препаратов.",
        # 4
        "Острые инфекционные заболевания менее чем за 30 дней до скрининга.",
        # 5
        "Регулярный или разовый прием любых лекарственных препаратов "
        "(включая витамины, препараты растительного происхождения "
        "и биологически активные добавки) менее чем за 30 дней до скрининга.",
        # 6
        "Донорство (> 450 мл крови или плазмы) менее чем за два месяца "
        "до скрининга.",
    ]

    # 7 — гормональные контрацептивы (только для женщин)
    if include_women:
        items.append(
            "Применение гормональных контрацептивов (у женщин) менее чем "
            "за 2 месяца до скрининга."
        )

    items.extend([
        # 8
        "Применение депо-инъекций или имплантация любых препаратов "
        "в течение 6 месяцев до скрининга.",
        # 9
        "Любые отклонения от нормальных значений при лабораторном "
        "и/или инструментальном обследовании на скрининге.",
        # 10
        "Положительный тест на содержание алкоголя в выдыхаемом воздухе.",
        # 11
        "Положительный тест на содержание наркотических "
        "и сильнодействующих лекарственных веществ в моче.",
    ])

    # 12 — тест на беременность (только для женщин)
    if include_women:
        items.append(
            "Положительный тест на беременность (по результатам тест-полосок) "
            "для женщин с сохраненным репродуктивным потенциалом."
        )

    # 13 — котинин (опционально, для некурящих)
    if include_cotinine:
        items.append("Положительный тест мочи на котинин.")

    items.extend([
        # 14
        "Положительные результаты тестов на маркеры гепатита В (HbsAg), "
        "С (HCV), сифилиса, ВИЧ-инфекцию.",
        # 15
        "Высокая вероятность возникновения проблем с успешной установкой "
        "венозного катетера или с выполнением пункции вены на предплечье.",
        # 16
        "Повышенная чувствительность к гепарину или "
        "гепарин-индуцированная тромбоцитопения в анамнезе.",
        # 17
        "Участие в другом клиническом исследовании менее чем за 3 месяца "
        "перед скринингом и/или параллельно с настоящим исследованием.",
    ])

    # 18 — гиперчувствительность к препарату (динамическое)
    drug_name = inn_ru or "___________"
    items.append(
        f"Гиперчувствительность к {drug_name}, или к любому другому "
        "компоненту, входящему в состав исследуемых лекарственных "
        "препаратов в анамнезе."
    )

    items.append(
        "Отягощенный аллергологический анамнез, "
        "лекарственная непереносимость."
    )

    # 20 — непереносимость лактозы (опционально)
    if include_lactose:
        items.append(
            "Непереносимость лактозы, дефицит лактазы или "
            "глюкозо-галактозная мальабсорбция."
        )

    items.extend([
        # 21
        "Прием более чем 10 ед. алкоголя в неделю в анамнезе "
        "(где каждая единица алкоголя эквивалентна 500 мл пива, "
        "200 мл вина или 50 мл крепких спиртных напитков) "
        "и/или анамнестические сведения об алкоголизме, наркомании, "
        "злоупотреблении лекарственными препаратами.",
        # 22
        "Дегидратация из-за диареи, рвоты или другой причины "
        "в течение последних 24 часов до приема исследуемого препарата.",
        # 23
        "Планирование пребывания в стационаре в период проведения "
        "исследования, по какому-либо поводу, кроме госпитализации, "
        "предусмотренной данным протоколом.",
        # 24
        "Наличие неустойчивой структуры сна (например, работа в ночную "
        "смену, нарушения сна, бессонница, недавнее возвращение из "
        "другого часового пояса и т.п.), экстремальные физические нагрузки "
        "(например, поднятие тяжестей).",
        # 25
        "Особая диета (например, вегетарианская, веганская, гипокалорийная "
        "(менее 1000 ккал/сут)) в течение 30 дней до скрининга "
        "и до завершения участия в исследовании.",
        # 26
        "Употребление следующих напитков и продуктов питания:\n"
        "\t• содержащих производные ксантина, оказывающих стимулирующее "
        "и/или метаболическое действие (шоколад, кофе, чай, газированные "
        "напитки, содержащие кофеин (кола), энергетические напитки, "
        "содержащие таурин, экстракт гуараны и т.д.) за 72 ч до приема "
        "исследуемых препаратов\n"
        "\t• содержащих ингибиторы или индукторы ферментных систем организма "
        "и переносчиков органических киназ (грейпфрут, помело, зверобой "
        "продырявленный, клюква) за 7 дней до приема исследуемых препаратов",
    ])

    # Пункты про женщин (только если включены)
    if include_women:
        items.extend([
            "Беременные или кормящие женщины или женщины, планирующие "
            "беременность во время клинического исследования; женщины "
            "с сохраненным репродуктивным потенциалом (в том числе "
            "не стерилизованные хирургическим путем и в периоде "
            "постменопаузы менее 2 лет), не использующие адекватных "
            "методов контрацепции.",

            "Женщины с сохраненным репродуктивным потенциалом, имеющие "
            "незащищенный половой акт с нестерилизованным партнером "
            "мужского пола в течение 30 дней до скрининга.",
        ])

    # Завершающие пункты (всегда последние)
    items.extend([
        "Неспособность читать или писать; нежелание понять и следовать "
        "процедурам протокола исследования; невыполнение процедур, которое, "
        "по мнению Исследователя, может повлиять на результаты исследования "
        "или безопасность добровольца и препятствовать дальнейшему участию "
        "добровольца в исследовании; любые другие сопутствующие медицинские "
        "или серьезные психические состояния, которые делают добровольца "
        "непригодным для участия в клиническом исследовании, ограничивают "
        "правомерность получения информированного согласия или могут повлиять "
        "на способность добровольца принять участие в исследовании.",

        f"Наличие по мнению Исследователя значимого риска или "
        f"противопоказания к применению препарата {drug_name}, "
        f"согласно инструкции по применению данного препарата.",
    ])

    header = (
        "Добровольцы не будут включены в исследование, "
        "если присутствует любой из следующих критериев:"
    )
    numbered = "\n".join(f"{i+1}.\t{item}" for i, item in enumerate(items))
    return f"{header}\n{numbered}"


def generate_exclusion_criteria(
    sex: str = "males_only",
    tmax_hours: Optional[float] = None,
    inn_ru: str = "",
) -> str:
    """
    Генерирует текст критериев исключения.

    Args:
        sex: "males_only" | "males_and_females"
        tmax_hours: Tmax в часах (для п.8: rвота/диарея = ceil(2×Tmax))
        inn_ru: МНН (для подстановки)
    """
    include_women = (sex == "males_and_females")

    # П.8: рвота/диарея — удвоенная величина Tmax, округлённая вверх
    if tmax_hours and tmax_hours > 0:
        vomiting_hours = math.ceil(2 * tmax_hours)
        tmax_rounded = math.ceil(tmax_hours)
        vomiting_text = (
            f"Возникновение рвоты/диареи в течение {vomiting_hours} часов "
            f"после приема препарата исследования "
            f"(удвоенная величина Тmax {inn_ru or ''}, "
            f"составляющая {tmax_rounded} ч)."
        )
    else:
        vomiting_text = (
            "Возникновение рвоты/диареи в течение _____ часов "
            "после приема препарата исследования "
            "(удвоенная величина Тmax _____, составляющая _____ ч)."
        )

    items = [
        "Доброволец отзывает согласие на участие в исследовании.",

        "Несоблюдение добровольцем требований протокола исследования "
        "(пропуск процедур исследования, самостоятельное применение "
        "препаратов, запрещенных в исследовании, нарушение ограничений "
        "в диете и образе жизни и т. д.).",

        "Доброволец был включен в исследование с нарушением требований "
        "критериев включения/невключения.",

        "Появление причин/возникновение в ходе исследования ситуаций, "
        "угрожающих безопасности добровольца (например, реакции "
        "гиперчувствительности и т. п.).",

        "Возникновение у добровольца в ходе исследования нежелательных "
        "и серьезных нежелательных явлений, когда продолжение участия "
        "добровольца в исследовании нежелательно или невозможно "
        "(по мнению Спонсора и/или Исследователя).",

        "Добровольцу проводится или требуется лечение, которое может "
        "повлиять на ФК параметры исследуемого препарата.",

        "Пропуск отбора 2-х и более проб крови подряд или 3-х и более "
        "проб крови в течение одного Периода ФК исследования.",

        vomiting_text,

        "Положительный тест мочи на содержание наркотических веществ "
        "и сильнодействующих лекарственных средств.",

        "Положительный тест на содержание паров алкоголя "
        "в выдыхаемом воздухе.",
    ]

    # П.11 — тест на беременность (только для женщин)
    if include_women:
        items.append("Положительный тест на беременность у женщин.")

    # Завершающий пункт (всегда последний)
    items.append(
        "Возникновение в ходе исследования иных причин, "
        "препятствующих проведению исследования согласно протоколу."
    )

    header = (
        "Доброволец должен быть досрочно выведен из клинического "
        "исследования если:"
    )
    numbered = "\n".join(f"{i+1}.\t{item}" for i, item in enumerate(items))
    return f"{header}\n{numbered}"