"""
agents/synopsis_generator.py ‚Äî Synopsis Generator Agent.

–ü–†–ò–ù–¶–ò–ü: —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –±–µ—Ä—É—Ç—Å—è –¢–û–ß–ù–û –∏–∑ —à–∞–±–ª–æ–Ω–∞ —Å–∏–Ω–æ–ø—Å–∏—Å–∞.
AI –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–∏—è/–Ω–µ–≤–∫–ª—é—á–µ–Ω–∏—è.
–¢–æ–ª—å–∫–æ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π + —É—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –∫—É—Ä–µ–Ω–∏–µ).

–ü–æ—Ä—è–¥–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –ï—Å–ª–∏ –ø—É–Ω–∫—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º ‚Äî –æ–Ω —É–±–∏—Ä–∞–µ—Ç—Å—è,
–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è.
"""

from typing import Any, Dict, List
from app.agents.base import BaseAgent, AgentResult
import logging

logger = logging.getLogger(__name__)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –®–ê–ë–õ–û–ù–ù–´–ï –¢–ï–ö–°–¢–´ (—Ç–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def _build_inclusion_criteria(
    sex: str,
    age_min: int,
    age_max: int,
    inn: str,
) -> str:
    """
    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–∏—è ‚Äî –¢–û–ß–ù–´–ô —Ç–µ–∫—Å—Ç –∏–∑ —à–∞–±–ª–æ–Ω–∞.
    –ü–æ—Ä—è–¥–æ–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –í–°–ï–ì–î–ê –ø–µ—Ä–≤–æ–µ.
    """
    include_women = sex != "males_only"

    sex_text = "–º—É–∂—á–∏–Ω—ã –∏ –∂–µ–Ω—â–∏–Ω—ã" if include_women else "–º—É–∂—á–∏–Ω—ã"
    weight_text = (
        "–±–æ–ª–µ–µ 45 –∫–≥ –¥–ª—è –∂–µ–Ω—â–∏–Ω –∏ –±–æ–ª–µ–µ 55 –∫–≥ –¥–ª—è –º—É–∂—á–∏–Ω –∏ –Ω–µ –±–æ–ª–µ–µ 110 –∫–≥"
        if include_women
        else "–±–æ–ª–µ–µ 55 –∫–≥ –∏ –Ω–µ –±–æ–ª–µ–µ 110 –∫–≥"
    )

    items: List[str] = []

    # 1. –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ ‚Äî –í–°–ï–ì–î–ê –ü–ï–†–í–û–ï
    items.append(
        "–ü–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è –ø–∏—Å—å–º–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è –¥–æ –Ω–∞—á–∞–ª–∞ "
        "–∫–∞–∫–∏—Ö-–ª–∏–±–æ –ø—Ä–æ—Ü–µ–¥—É—Ä —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞, –∞ —Ç–∞–∫–∂–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –ø–æ –º–Ω–µ–Ω–∏—é "
        "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è, —Å–ª–µ–¥–æ–≤–∞—Ç—å –≤—Å–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ü—Ä–æ—Ç–æ–∫–æ–ª–∞."
    )

    # 2. –ü–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –∫—É—Ä–µ–Ω–∏–µ
    items.append(
        f"–ù–µ–∫—É—Ä—è—â–∏–µ {sex_text} –≤ –≤–æ–∑—Ä–∞—Å—Ç–µ –æ—Ç {age_min} –¥–æ {age_max} –ª–µ—Ç "
        f"–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è —Ñ–æ—Ä–º—ã –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è."
    )

    # 3. –ó–¥–æ—Ä–æ–≤
    items.append(
        "–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ ¬´–∑–¥–æ—Ä–æ–≤¬ª –ø–æ –¥–∞–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö, "
        "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è."
    )

    # 4. –ò–ú–¢
    items.append(
        f"–ò–Ω–¥–µ–∫—Å –º–∞—Å—Å—ã —Ç–µ–ª–∞ (–ò–ú–¢) –æ—Ç 18,5 –¥–æ 30,0 –∫–≥/–º¬≤ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ), "
        f"–ø—Ä–∏ –º–∞—Å—Å–µ —Ç–µ–ª–∞ {weight_text}."
    )

    # 5. –ê–î
    items.append(
        "–£—Ä–æ–≤–µ–Ω—å –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è (–ê–î): —Å–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ "
        "–¥–∞–≤–ª–µ–Ω–∏–µ (–°–ê–î) –æ—Ç 100 –¥–æ 129 –º–º —Ä—Ç. —Å—Ç. (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ), "
        "–¥–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ (–î–ê–î) –æ—Ç 60 –¥–æ 89 –º–º —Ä—Ç. —Å—Ç. "
        "(–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)."
    )

    # 6. –ß–°–°
    items.append(
        "–ß–∞—Å—Ç–æ—Ç–∞ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π (–ß–°–°) –æ—Ç 60 –¥–æ 89 —É–¥–∞—Ä–æ–≤ –≤ 1 –º–∏–Ω—É—Ç—É "
        "(–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)."
    )

    # 7. –ß–î–î
    items.append(
        "–ß–∞—Å—Ç–æ—Ç–∞ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π (–ß–î–î) –æ—Ç 12 –¥–æ 20 –≤ 1 –º–∏–Ω—É—Ç—É "
        "(–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)."
    )

    # 8. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
    items.append(
        "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ª–∞ –æ—Ç 36¬∞C –¥–æ 36,9¬∞C (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)."
    )

    # 9. –ê–ª–∫–æ–≥–æ–ª—å
    items.append(
        "–û—Ç–∫–∞–∑ –æ—Ç –ø—Ä–∏–µ–º–∞ –∞–ª–∫–æ–≥–æ–ª—è –≤ —Ç–µ—á–µ–Ω–∏–µ 72 —á–∞—Å–æ–≤ –¥–æ –Ω–∞—á–∞–ª–∞ –∫–∞–∫–∏—Ö-–ª–∏–±–æ "
        "–ø—Ä–æ—Ü–µ–¥—É—Ä —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è."
    )

    # 10. –ö–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏—è
    contraception = (
        "–°–æ–≥–ª–∞—Å–∏–µ –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∫–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏–∏ "
        "–Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –º–µ—Å—è—Ü–∞ –ø–æ—Å–ª–µ –µ–≥–æ "
        "–æ–∫–æ–Ω—á–∞–Ω–∏—è. –ö –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–º –º–µ—Ç–æ–¥–∞–º –∫–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏–∏ –æ—Ç–Ω–æ—Å—è—Ç—Å—è: –≤–æ–∑–¥–µ—Ä–∂–∞–Ω–∏–µ "
        "–æ—Ç –ø–æ–ª–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –∫—Ä–æ–º–µ —Ç–æ–≥–æ, –¥–ª—è –º—É–∂—á–∏–Ω: –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤ —Å–æ "
        "—Å–ø–µ—Ä–º–∏—Ü–∏–¥–æ–º (–ø–µ–Ω–∞, –≥–µ–ª—å, –∫—Ä–µ–º)"
    )
    if include_women:
        contraception += (
            ", –¥–ª—è –∂–µ–Ω—â–∏–Ω –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤ (–¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞), –¥–∏–∞—Ñ—Ä–∞–≥–º–∞ –∏–ª–∏ —à–µ–µ—á–Ω—ã–π "
            "–∫–æ–ª–ø–∞—á–æ–∫ —Å–æ —Å–ø–µ—Ä–º–∏—Ü–∏–¥–æ–º, –≤–Ω—É—Ç—Ä–∏–º–∞—Ç–æ—á–Ω–∞—è —Å–ø–∏—Ä–∞–ª—å"
        )
    contraception += "."
    items.append(contraception)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    header = (
        "–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü—ã –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å "
        "–≤—Å–µ–º —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –≤–∫–ª—é—á–µ–Ω–∏—è:\n"
    )
    numbered = "\n".join(f"{i+1}. {item}" for i, item in enumerate(items))
    return header + numbered


def _build_exclusion_criteria(
    sex: str,
    inn: str,
    ref_drug: str,
) -> str:
    """
    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–µ–≤–∫–ª—é—á–µ–Ω–∏—è ‚Äî –¢–û–ß–ù–´–ô —Ç–µ–∫—Å—Ç –∏–∑ —à–∞–±–ª–æ–Ω–∞.
    –ü—É–Ω–∫—Ç—ã –ø—Ä–æ –∂–µ–Ω—â–∏–Ω –≤–∫–ª—é—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ sex != males_only.
    """
    include_women = sex != "males_only"

    items: List[str] = []

    items.append(
        "–ù–∞–ª–∏—á–∏–µ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ –æ—Å—Ç—Ä—ã—Ö –∏–ª–∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π "
        "—Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç–æ–π, –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–æ–π, –Ω–µ—Ä–≤–Ω–æ–π, —ç–Ω–¥–æ–∫—Ä–∏–Ω–Ω–æ–π, "
        "–æ–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω–æ–π, –∫—Ä–æ–≤–µ—Ç–≤–æ—Ä–Ω–æ–π –∏ –∏–º–º—É–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º, –ø–æ—á–µ–∫ "
        "–∏ –º–æ—á–µ–≤—ã–≤–æ–¥—è—â–∏—Ö –ø—É—Ç–µ–π, –ø–µ—á–µ–Ω–∏ –∏ –∂–µ–ª—á–µ–≤—ã–≤–æ–¥—è—â–∏—Ö –ø—É—Ç–µ–π, "
        "–∂–µ–ª—É–¥–æ—á–Ω–æ-–∫–∏—à–µ—á–Ω–æ–≥–æ —Ç—Ä–∞–∫—Ç–∞ (–ñ–ö–¢), –∫–æ–∂–∏, –∞ —Ç–∞–∫–∂–µ –¥–æ–±—Ä–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö "
        "–æ–ø—É—Ö–æ–ª–µ–≤—ã—Ö –∏ –æ–Ω–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π."
    )

    items.append(
        "–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–∞ –ñ–ö–¢ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ "
        "(–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –∞–ø–ø–µ–Ω–¥—ç–∫—Ç–æ–º–∏–∏ –Ω–µ –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 1 –≥–æ–¥ –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞)."
    )

    items.append(
        "–ó–∞–±–æ–ª–µ–≤–∞–Ω–∏—è/—Å–æ—Å—Ç–æ—è–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ, –ø–æ –º–Ω–µ–Ω–∏—é –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è, –º–æ–≥—É—Ç "
        "–ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –∞–±—Å–æ—Ä–±—Ü–∏—é, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏–ª–∏ —ç–∫—Å–∫—Ä–µ—Ü–∏—é "
        "–∏—Å—Å–ª–µ–¥—É–µ–º—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤."
    )

    items.append(
        "–û—Å—Ç—Ä—ã–µ –∏–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 30 –¥–Ω–µ–π –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞."
    )

    items.append(
        "–†–µ–≥—É–ª—è—Ä–Ω—ã–π –∏–ª–∏ —Ä–∞–∑–æ–≤—ã–π –ø—Ä–∏–µ–º –ª—é–±—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ "
        "(–≤–∫–ª—é—á–∞—è –≤–∏—Ç–∞–º–∏–Ω—ã, –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è "
        "–∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏) –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 30 –¥–Ω–µ–π –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞."
    )

    items.append(
        "–î–æ–Ω–æ—Ä—Å—Ç–≤–æ (> 450 –º–ª –∫—Ä–æ–≤–∏ –∏–ª–∏ –ø–ª–∞–∑–º—ã) –º–µ–Ω–µ–µ —á–µ–º –∑–∞ –¥–≤–∞ –º–µ—Å—è—Ü–∞ "
        "–¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞."
    )

    if include_women:
        items.append(
            "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ç–∏–≤–æ–≤ (—É –∂–µ–Ω—â–∏–Ω) "
            "–º–µ–Ω–µ–µ —á–µ–º –∑–∞ 2 –º–µ—Å—è—Ü–∞ –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞."
        )

    items.append(
        "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–µ–ø–æ-–∏–Ω—ä–µ–∫—Ü–∏–π –∏–ª–∏ –∏–º–ø–ª–∞–Ω—Ç–∞—Ü–∏—è –ª—é–±—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ "
        "–≤ —Ç–µ—á–µ–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤ –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞."
    )

    items.append(
        "–õ—é–±—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–º "
        "–∏/–∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ –Ω–∞ —Å–∫—Ä–∏–Ω–∏–Ω–≥–µ."
    )

    items.append(
        "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∞–ª–∫–æ–≥–æ–ª—è –≤ –≤—ã–¥—ã—Ö–∞–µ–º–æ–º –≤–æ–∑–¥—É—Ö–µ."
    )

    items.append(
        "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞—Ä–∫–æ—Ç–∏—á–µ—Å–∫–∏—Ö "
        "–∏ —Å–∏–ª—å–Ω–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤ –≤ –º–æ—á–µ."
    )

    if include_women:
        items.append(
            "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å (–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ç–µ—Å—Ç –ø–æ–ª–æ—Å–æ–∫) "
            "–¥–ª—è –∂–µ–Ω—â–∏–Ω —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º."
        )

    items.append("–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç –º–æ—á–∏ –Ω–∞ –∫–æ—Ç–∏–Ω–∏–Ω.")

    items.append(
        "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã –≥–µ–ø–∞—Ç–∏—Ç–∞ –í (HBsAg), "
        "–° (HCV), —Å–∏—Ñ–∏–ª–∏—Å–∞, –í–ò–ß-–∏–Ω—Ñ–µ–∫—Ü–∏—é."
    )

    items.append(
        "–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π "
        "–≤–µ–Ω–æ–∑–Ω–æ–≥–æ –∫–∞—Ç–µ—Ç–µ—Ä–∞ –∏–ª–∏ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—É–Ω–∫—Ü–∏–∏ –≤–µ–Ω—ã –Ω–∞ –ø—Ä–µ–¥–ø–ª–µ—á—å–µ."
    )

    items.append(
        "–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≥–µ–ø–∞—Ä–∏–Ω—É –∏–ª–∏ "
        "–≥–µ–ø–∞—Ä–∏–Ω-–∏–Ω–¥—É—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç—Ä–æ–º–±–æ—Ü–∏—Ç–æ–ø–µ–Ω–∏—è –≤ –∞–Ω–∞–º–Ω–µ–∑–µ."
    )

    items.append(
        "–£—á–∞—Å—Ç–∏–µ –≤ –¥—Ä—É–≥–æ–º –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 3 –º–µ—Å—è—Ü–∞ "
        "–ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–Ω–∏–Ω–≥–æ–º –∏/–∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º."
    )

    items.append(
        f"–ì–∏–ø–µ—Ä—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ {inn}, –∏–ª–∏ –∫ –ª—é–±–æ–º—É –¥—Ä—É–≥–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É, "
        f"–≤—Ö–æ–¥—è—â–µ–º—É –≤ —Å–æ—Å—Ç–∞–≤ –∏—Å—Å–ª–µ–¥—É–µ–º—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ."
    )

    items.append(
        "–û—Ç—è–≥–æ—â–µ–Ω–Ω—ã–π –∞–ª–ª–µ—Ä–≥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–º–Ω–µ–∑, –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å."
    )

    items.append(
        "–ù–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ª–∞–∫—Ç–æ–∑—ã, –¥–µ—Ñ–∏—Ü–∏—Ç –ª–∞–∫—Ç–∞–∑—ã –∏–ª–∏ "
        "–≥–ª—é–∫–æ–∑–æ-–≥–∞–ª–∞–∫—Ç–æ–∑–Ω–∞—è –º–∞–ª—å–∞–±—Å–æ—Ä–±—Ü–∏—è."
    )

    items.append(
        "–ü—Ä–∏–µ–º –±–æ–ª–µ–µ —á–µ–º 10 –µ–¥. –∞–ª–∫–æ–≥–æ–ª—è –≤ –Ω–µ–¥–µ–ª—é –≤ –∞–Ω–∞–º–Ω–µ–∑–µ "
        "(–≥–¥–µ –∫–∞–∂–¥–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –∞–ª–∫–æ–≥–æ–ª—è —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–∞ 500 –º–ª –ø–∏–≤–∞, "
        "200 –º–ª –≤–∏–Ω–∞ –∏–ª–∏ 50 –º–ª –∫—Ä–µ–ø–∫–∏—Ö —Å–ø–∏—Ä—Ç–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤) "
        "–∏/–∏–ª–∏ –∞–Ω–∞–º–Ω–µ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è –æ–± –∞–ª–∫–æ–≥–æ–ª–∏–∑–º–µ, –Ω–∞—Ä–∫–æ–º–∞–Ω–∏–∏, "
        "–∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏."
    )

    items.append(
        "–î–µ–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –∏–∑-–∑–∞ –¥–∏–∞—Ä–µ–∏, —Ä–≤–æ—Ç—ã –∏–ª–∏ –¥—Ä—É–≥–æ–π –ø—Ä–∏—á–∏–Ω—ã "
        "–≤ —Ç–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 24 —á–∞—Å–æ–≤ –¥–æ –ø—Ä–∏–µ–º–∞ –∏—Å—Å–ª–µ–¥—É–µ–º–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞."
    )

    items.append(
        "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –≤ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ –≤ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è "
        "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø–æ –∫–∞–∫–æ–º—É-–ª–∏–±–æ –ø–æ–≤–æ–¥—É, –∫—Ä–æ–º–µ –≥–æ—Å–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏, "
        "–ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–π –¥–∞–Ω–Ω—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º."
    )

    items.append(
        "–ù–∞–ª–∏—á–∏–µ –Ω–µ—É—Å—Ç–æ–π—á–∏–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–±–æ—Ç–∞ –≤ –Ω–æ—á–Ω—É—é —Å–º–µ–Ω—É, "
        "–Ω–∞—Ä—É—à–µ–Ω–∏—è —Å–Ω–∞, –±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞, –Ω–µ–¥–∞–≤–Ω–µ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ "
        "–ø–æ—è—Å–∞ –∏ —Ç.–ø.), —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ "
        "(–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥–Ω—è—Ç–∏–µ —Ç—è–∂–µ—Å—Ç–µ–π)."
    )

    items.append(
        "–û—Å–æ–±–∞—è –¥–∏–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∞—è, –≤–µ–≥–∞–Ω—Å–∫–∞—è, –≥–∏–ø–æ–∫–∞–ª–æ—Ä–∏–π–Ω–∞—è "
        "(–º–µ–Ω–µ–µ 1000 –∫–∫–∞–ª/—Å—É—Ç)) –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ "
        "–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—á–∞—Å—Ç–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏."
    )

    items.append(
        "–£–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–∏—Ç–∞–Ω–∏—è: "
        "—Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –∫—Å–∞–Ω—Ç–∏–Ω–∞ (—à–æ–∫–æ–ª–∞–¥, –∫–æ—Ñ–µ, —á–∞–π, –≥–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ "
        "–Ω–∞–ø–∏—Ç–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∫–æ—Ñ–µ–∏–Ω, —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏) –∑–∞ 72 —á –¥–æ –ø—Ä–∏–µ–º–∞ "
        "–∏—Å—Å–ª–µ–¥—É–µ–º—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤; —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –∏–Ω–≥–∏–±–∏—Ç–æ—Ä—ã –∏–ª–∏ –∏–Ω–¥—É–∫—Ç–æ—Ä—ã —Ñ–µ—Ä–º–µ–Ω—Ç–Ω—ã—Ö "
        "—Å–∏—Å—Ç–µ–º –æ—Ä–≥–∞–Ω–∏–∑–º–∞ (–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç, –ø–æ–º–µ–ª–æ, –∑–≤–µ—Ä–æ–±–æ–π –ø—Ä–æ–¥—ã—Ä—è–≤–ª–µ–Ω–Ω—ã–π, –∫–ª—é–∫–≤–∞) "
        "–∑–∞ 7 –¥–Ω–µ–π –¥–æ –ø—Ä–∏–µ–º–∞ –∏—Å—Å–ª–µ–¥—É–µ–º—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤."
    )

    if include_women:
        items.append(
            "–ë–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–ª–∏ –∫–æ—Ä–º—è—â–∏–µ –∂–µ–Ω—â–∏–Ω—ã –∏–ª–∏ –∂–µ–Ω—â–∏–Ω—ã, –ø–ª–∞–Ω–∏—Ä—É—é—â–∏–µ "
            "–±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –≤–æ –≤—Ä–µ–º—è –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è; –∂–µ–Ω—â–∏–Ω—ã "
            "—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º (–≤ —Ç–æ–º —á–∏—Å–ª–µ –Ω–µ "
            "—Å—Ç–µ—Ä–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ö–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–º –ø—É—Ç–µ–º –∏ –≤ –ø–µ—Ä–∏–æ–¥–µ –ø–æ—Å—Ç–º–µ–Ω–æ–ø–∞—É–∑—ã "
            "–º–µ–Ω–µ–µ 2 –ª–µ—Ç), –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∫–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏–∏."
        )
        items.append(
            "–ñ–µ–Ω—â–∏–Ω—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º, –∏–º–µ—é—â–∏–µ "
            "–Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–π –ø–æ–ª–æ–≤–æ–π –∞–∫—Ç —Å –Ω–µ—Å—Ç–µ—Ä–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º "
            "–º—É–∂—Å–∫–æ–≥–æ –ø–æ–ª–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –¥–æ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞."
        )

    items.append(
        "–ù–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —á–∏—Ç–∞—Ç—å –∏–ª–∏ –ø–∏—Å–∞—Ç—å; –Ω–µ–∂–µ–ª–∞–Ω–∏–µ –ø–æ–Ω—è—Ç—å –∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å "
        "–ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è; –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä, –∫–æ—Ç–æ—Ä–æ–µ, "
        "–ø–æ –º–Ω–µ–Ω–∏—é –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è, –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è "
        "–∏–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–∞ –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —É—á–∞—Å—Ç–∏—é "
        "–¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–∞ –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏; –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ "
        "–∏–ª–∏ —Å–µ—Ä—å–µ–∑–Ω—ã–µ –ø—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–∞ "
        "–Ω–µ–ø—Ä–∏–≥–æ–¥–Ω—ã–º –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç "
        "–ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è –∏–ª–∏ –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å "
        "–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–∞ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏."
    )

    items.append(
        f"–ù–∞–ª–∏—á–∏–µ –ø–æ –º–Ω–µ–Ω–∏—é –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è –∑–Ω–∞—á–∏–º–æ–≥–æ —Ä–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è "
        f"–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ {ref_drug}, —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ "
        f"–ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞."
    )

    header = (
        "–î–æ–±—Ä–æ–≤–æ–ª—å—Ü—ã –Ω–µ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, "
        "–µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª—é–±–æ–π –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:\n"
    )
    numbered = "\n".join(f"{i+1}. {item}" for i, item in enumerate(items))
    return header + numbered


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ê–ì–ï–ù–¢
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class SynopsisGeneratorAgent(BaseAgent):
    """
    Synopsis Generator ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–û–ß–ù–´–ï —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞. LLM —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—Ç–æ–±–∑–æ—Ä–∞.
    """

    async def run(self, input_data: Dict[str, Any]) -> AgentResult:
        # ‚îÄ‚îÄ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ ‚îÄ‚îÄ
        inn_ru = input_data.get("inn_ru", "")
        dosage_form = input_data.get("dosage_form", "")
        dosage = input_data.get("dosage", "")
        release_type = input_data.get("release_type", "immediate")
        drug_name_trade = input_data.get("drug_name_trade", "")
        reference_drug_name = input_data.get("reference_drug_name", "")
        sponsor = input_data.get("sponsor_name", "________")
        center = input_data.get("research_center", "________")
        lab = input_data.get("bioanalytical_lab", "________")
        insurance = input_data.get("insurance_company", "________")
        sex = input_data.get("sex_restriction", "males_only")
        age_min = input_data.get("age_min", 18)
        age_max = input_data.get("age_max", 45)
        smoking = input_data.get("smoking_restriction", "non_smokers")

        pk = input_data.get("pk", {})
        if hasattr(pk, "model_dump"):
            pk = pk.model_dump()

        design = input_data.get("design", {})
        if hasattr(design, "model_dump"):
            design = design.model_dump()

        sample = input_data.get("sample_size", {})
        if hasattr(sample, "model_dump"):
            sample = sample.model_dump()

        ref_drug = pk.get("reference_drug", reference_drug_name) or "________"
        intake_mode = design.get("intake_mode", "fasting")
        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –∑–∞–¥–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å intake_mode —è–≤–Ω–æ —á–µ—Ä–µ–∑ CLI
        intake_mode_input = input_data.get("intake_mode") is not None
        n_total = sample.get("n_total", 24)

        # ‚îÄ‚îÄ –¢–µ–∫—Å—Ç –¥–∏–∑–∞–π–Ω–∞ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ ‚îÄ‚îÄ
        design_type = design.get("design_type", "2x2_crossover")
        if hasattr(design_type, "value"):
            design_type = design_type.value
        n_periods = int(design.get("n_periods", 2) or 2)
        n_sequences = int(design.get("n_sequences", 2) or 2)

        _periods_word = {1: "–æ–¥–Ω–æ–º", 2: "–¥–≤—É—Ö", 3: "—Ç—Ä—ë—Ö", 4: "—á–µ—Ç—ã—Ä—ë—Ö"}.get(n_periods, str(n_periods))
        _seq_word = {2: "–¥–≤—É—Ö", 3: "—Ç—Ä—ë—Ö", 4: "—á–µ—Ç—ã—Ä—ë—Ö"}.get(n_sequences, str(n_sequences))

        # –ú–∞–ø–ø–∏–Ω–≥ –¥–∏–∑–∞–π–Ω–∞ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (–ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)
        _title_map = {
            # –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã–π
            "2x2_crossover": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö",
            "3x3_crossover": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö",
            # –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–π
            "partial_replicate": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö —Å —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ–π —Å—Ö–µ–º–æ–π",
            "replicate_3_period": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö —Å —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ–π —Å—Ö–µ–º–æ–π",
            # –ü–æ–ª–Ω—ã–π —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–π
            "full_replicate_3_period": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö —Å –ø–æ–ª–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ–π —Å—Ö–µ–º–æ–π",
            "full_replicate_4_period": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö —Å –ø–æ–ª–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ–π —Å—Ö–µ–º–æ–π",
            "replicate_4_period": f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö —Å –ø–æ–ª–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ–π —Å—Ö–µ–º–æ–π",
            # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π
            "parallel_1_period": "–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö",
            "parallel_2_period": f"–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö",
            "parallel": "–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö",
            # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π
            "adaptive_crossover": f"–¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ",
            "adaptive_parallel_1": "–¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ",
            "adaptive_parallel_2": f"–¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ",
        }
        design_title_text = _title_map.get(
            design_type,
            f"–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ {_seq_word} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö"
        )

        # ‚îÄ‚îÄ –¢–µ–∫—Å—Ç –ø—Ä–∏—ë–º–∞ ‚îÄ‚îÄ
        if hasattr(intake_mode, "value"):
            intake_mode = intake_mode.value
        intake_text_short = {
            "fasting": "–Ω–∞—Ç–æ—â–∞–∫",
            "fed": "–ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –ø–∏—â–∏",
            "both": "–Ω–∞—Ç–æ—â–∞–∫ –∏ –ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –ø–∏—â–∏",
        }.get(intake_mode, "–Ω–∞—Ç–æ—â–∞–∫")

        # ‚îÄ‚îÄ –¢–µ–∫—Å—Ç –∏—Å—Å–ª–µ–¥—É–µ–º–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ ‚îÄ‚îÄ
        # –§–æ—Ä–º–∞—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ, –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–æ–∑–∏—Ä–æ–≤–∫–∞ (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å, –°—Ç—Ä–∞–Ω–∞)
        mfr_name = input_data.get("manufacturer_name", "")
        mfr_country = input_data.get("manufacturer_country", "")
        test_drug_short = f"{drug_name_trade or inn_ru}, {dosage_form}, {dosage}"
        if mfr_name:
            mfr_str = f"{mfr_name}, {mfr_country}" if mfr_country else mfr_name
            test_drug_full = f"{drug_name_trade or inn_ru}, {dosage_form} {dosage} ({mfr_str})"
        else:
            test_drug_full = test_drug_short

        # ‚îÄ‚îÄ –¢–µ–∫—Å—Ç —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ ‚îÄ‚îÄ
        # –§–æ—Ä–º–∞—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ, –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–æ–∑–∏—Ä–æ–≤–∫–∞ (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å, –°—Ç—Ä–∞–Ω–∞)
        # –î–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ fetch_drug_info, –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫–∏
        ref_drug_title = f"{ref_drug}, {dosage_form} {dosage}"

        # ‚îÄ‚îÄ –ü–æ–ª –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è ‚îÄ‚îÄ
        # "–∂–µ–Ω—Å–∫–æ–≥–æ –ø–æ–ª–∞" –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ females_only
        sex_title_text = ""  # –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ fetch_drug_info

        # ‚îÄ‚îÄ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∏–Ω–æ–ø—Å–∏—Å–∞ ‚îÄ‚îÄ
        synopsis = {}

        # protocol_title –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ fetch_drug_info (–Ω–∏–∂–µ)
        synopsis["sponsor"] = sponsor
        synopsis["research_center"] = center
        synopsis["bioanalytical_lab"] = lab
        synopsis["insurance_company"] = insurance
        synopsis["test_drug"] = test_drug_short
        synopsis["reference_drug"] = ref_drug
        synopsis["inn"] = inn_ru
        synopsis["dosage_form"] = dosage_form
        synopsis["dosage"] = dosage
        synopsis["n_subjects"] = str(n_total)
        synopsis["protocol_version"] = "1.0"
        synopsis["study_id"] = input_data.get("study_id", "")
        synopsis["manufacturer"] = input_data.get("manufacturer_name", "")
        synopsis["manufacturer_country"] = input_data.get("manufacturer_country", "")
        synopsis["storage_conditions"] = input_data.get("storage_conditions", "")
        synopsis["excipients"] = input_data.get("excipients", "")
        synopsis["composition"] = input_data.get("composition", "")

        # ‚îÄ‚îÄ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–æ–º—É –ø—Ä–µ–ø–∞—Ä–∞—Ç—É ‚îÄ‚îÄ
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º drug_info, —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –≤ PK Agent (–æ–¥–∏–Ω –ø–∞—Ä—Å–∏–Ω–≥!)
        _drug_info_from_pk = input_data.get("drug_info")
        if _drug_info_from_pk:
            try:
                try:
                    from app.utils.drug_info_parser import drug_info_to_dict
                except ImportError:
                    from drug_info_parser import drug_info_to_dict
                ref_dict = drug_info_to_dict(_drug_info_from_pk)
                synopsis.update(ref_dict)
                if _drug_info_from_pk.source_url:
                    logger.info(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫ {ref_drug} (–∏–∑ PK Agent): {_drug_info_from_pk.source_url}")
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ drug_info_to_dict: {e}")
        else:
            # Fallback: –µ—Å–ª–∏ PK Agent –Ω–µ –≤–µ—Ä–Ω—É–ª drug_info ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º
            try:
                try:
                    from app.utils.drug_info_parser import fetch_drug_info, drug_info_to_dict
                except ImportError:
                    try:
                        from drug_info_parser import fetch_drug_info, drug_info_to_dict
                    except ImportError:
                        fetch_drug_info = None

                _drug_name_for_fetch = reference_drug_name or ref_drug
                if fetch_drug_info and _drug_name_for_fetch and _drug_name_for_fetch != "________":
                    ref_info = await fetch_drug_info(
                        drug_name=_drug_name_for_fetch,
                        inn=inn_ru,
                        dosage=dosage,
                    )
                    ref_dict = drug_info_to_dict(ref_info)
                    synopsis.update(ref_dict)
                    if ref_info.source_url:
                        logger.info(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫ {_drug_name_for_fetch} (fallback): {ref_info.source_url}")
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: {e}")

        # ‚îÄ‚îÄ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö (–∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω) ‚îÄ‚îÄ
        # –ò—â–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è: —Å–ø–æ–Ω—Å–æ—Ä, —Ü–µ–Ω—Ç—Ä, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è, —Å—Ç—Ä–∞—Ö–æ–≤–∞—è
        try:
            from app.services.search.yandex_search import (
                search_organization_info, format_sponsor_field,
            )
            _has_org_search = True
        except ImportError:
            try:
                from yandex_search import search_organization_info, format_sponsor_field
                _has_org_search = True
            except ImportError:
                _has_org_search = False

        if not _has_org_search:
            print("  ‚ö†Ô∏è yandex_search –º–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –æ—Ç–∫–ª—é—á—ë–Ω")
        else:
            print(f"  üîé –ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π: —Å–ø–æ–Ω—Å–æ—Ä={sponsor}, —Ü–µ–Ω—Ç—Ä={center}, –ª–∞–±={lab}, —Å—Ç—Ä–∞—Ö–æ–≤–∞—è={insurance}")

            import time
            _org_query_count = 0

            def _org_search_with_delay(name: str, country: str = "–†–æ—Å—Å–∏—è"):
                """–ü–æ–∏—Å–∫ —Å –ø–∞—É–∑–æ–π 1.5 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (Yandex rate limit: 1 req/sec)."""
                nonlocal _org_query_count
                if _org_query_count > 0:
                    time.sleep(1.5)
                _org_query_count += 1
                return search_organization_info(name, country)

        if _has_org_search:
            import time as _time
            sponsor_country = input_data.get("sponsor_country", "–†–æ—Å—Å–∏—è")

            # –°–ø–æ–Ω—Å–æ—Ä
            if sponsor and sponsor != "________":
                try:
                    org_info = _org_search_with_delay(sponsor, sponsor_country)
                    if org_info.get("address") or org_info.get("phone"):
                        sponsor_full = format_sponsor_field(org_info)
                        synopsis["sponsor"] = sponsor_full
                        print(f"  ‚úÖ –°–ø–æ–Ω—Å–æ—Ä –Ω–∞–π–¥–µ–Ω: {org_info.get('address', '')}")
                    else:
                        print(f"  ‚ö†Ô∏è –°–ø–æ–Ω—Å–æ—Ä: Yandex –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–¥—Ä–µ—Å/—Ç–µ–ª–µ—Ñ–æ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è –°–ø–æ–Ω—Å–æ—Ä –æ—à–∏–±–∫–∞: {e}")
                    logger.warning(f"‚ö†Ô∏è –°–ø–æ–Ω—Å–æ—Ä: {e}")

            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ Yandex GenSearch
            _time.sleep(1)

            # –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä
            if center and center != "________":
                try:
                    center_info = _org_search_with_delay(center, "–†–æ—Å—Å–∏—è")
                    if center_info.get("address") or center_info.get("phone"):
                        center_full = format_sponsor_field(center_info)
                        synopsis["research_center"] = center_full
                        print(f"  ‚úÖ –¶–µ–Ω—Ç—Ä –Ω–∞–π–¥–µ–Ω: {center_info.get('address', '')}")
                    else:
                        print(f"  ‚ö†Ô∏è –¶–µ–Ω—Ç—Ä: Yandex –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–¥—Ä–µ—Å/—Ç–µ–ª–µ—Ñ–æ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è –¶–µ–Ω—Ç—Ä –æ—à–∏–±–∫–∞: {e}")
                    logger.warning(f"‚ö†Ô∏è –¶–µ–Ω—Ç—Ä: {e}")

            _time.sleep(1)

            # –ë–∏–æ–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è
            if lab and lab != "________":
                try:
                    # –ï—Å–ª–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è = —Ü–µ–Ω—Ç—Ä ‚Äî –Ω–µ –∏—â–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    if lab == center and synopsis.get("research_center"):
                        synopsis["bioanalytical_lab"] = synopsis["research_center"]
                        print(f"  ‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è = –¶–µ–Ω—Ç—Ä (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫)")
                    else:
                        lab_info = _org_search_with_delay(lab, "–†–æ—Å—Å–∏—è")
                        if lab_info.get("address") or lab_info.get("phone"):
                            lab_full = format_sponsor_field(lab_info)
                            synopsis["bioanalytical_lab"] = lab_full
                            print(f"  ‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞: {lab_info.get('address', '')}")
                        else:
                            print(f"  ‚ö†Ô∏è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è: Yandex –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–¥—Ä–µ—Å/—Ç–µ–ª–µ—Ñ–æ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –æ—à–∏–±–∫–∞: {e}")
                    logger.warning(f"‚ö†Ô∏è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è: {e}")

            _time.sleep(1)

            # –°—Ç—Ä–∞—Ö–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è
            if insurance and insurance != "________":
                try:
                    ins_info = _org_search_with_delay(insurance, "–†–æ—Å—Å–∏—è")
                    if ins_info.get("address") or ins_info.get("phone"):
                        ins_full = format_sponsor_field(ins_info)
                        synopsis["insurance_company"] = ins_full
                        print(f"  ‚úÖ –°—Ç—Ä–∞—Ö–æ–≤–∞—è –Ω–∞–π–¥–µ–Ω–∞: {ins_info.get('address', '')}")
                    else:
                        print(f"  ‚ö†Ô∏è –°—Ç—Ä–∞—Ö–æ–≤–∞—è: Yandex –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–¥—Ä–µ—Å/—Ç–µ–ª–µ—Ñ–æ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è –°—Ç—Ä–∞—Ö–æ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
                    logger.warning(f"‚ö†Ô∏è –°—Ç—Ä–∞—Ö–æ–≤–∞—è: {e}")

        # –ö—Ä–∏—Ç–µ—Ä–∏–∏ ‚Äî –¢–û–ß–ù–´–ô —Ç–µ–∫—Å—Ç –∏–∑ —à–∞–±–ª–æ–Ω–∞
        # –ï—Å–ª–∏ –ø–∞—Ä—Å–µ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–∏–ª —á—Ç–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω ‚Äî
        # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ø–æ–ª –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–≤
        if synopsis.get("suggested_sex") and synopsis["suggested_sex"] != "males_only":
            sex = synopsis["suggested_sex"]
            logger.info(f"‚ÑπÔ∏è –ü–æ–ª –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–≤ –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫ {ref_drug}: {sex}")

        # –ï—Å–ª–∏ –ø–∞—Ä—Å–µ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Ä–µ–∂–∏–º –ø—Ä–∏—ë–º–∞ (–Ω–∞—Ç–æ—â–∞–∫/–ø–æ—Å–ª–µ –µ–¥—ã) ‚Äî
        # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º intake_mode –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
        if synopsis.get("suggested_intake") and not intake_mode_input:
            _suggested = synopsis["suggested_intake"]
            if _suggested in ("fasting", "fed", "both"):
                intake_mode = _suggested
                intake_text_short = {
                    "fasting": "–Ω–∞—Ç–æ—â–∞–∫",
                    "fed": "–ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –ø–∏—â–∏",
                    "both": "–Ω–∞—Ç–æ—â–∞–∫ –∏ –ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –ø–∏—â–∏",
                }.get(intake_mode, "–Ω–∞—Ç–æ—â–∞–∫")
                logger.info(f"‚ÑπÔ∏è –†–µ–∂–∏–º –ø—Ä–∏—ë–º–∞ –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫ {ref_drug}: {_suggested}")
        elif not intake_mode_input and (reference_drug_name or ref_drug):
            # Fallback: –∏—â–µ–º —Ä–µ–∂–∏–º –ø—Ä–∏—ë–º–∞ —á–µ—Ä–µ–∑ Yandex Search
            try:
                from app.services.search.yandex_search import search_intake_mode
            except ImportError:
                try:
                    from yandex_search import search_intake_mode
                except ImportError:
                    search_intake_mode = None
            if search_intake_mode:
                try:
                    _intake_result = search_intake_mode(
                        ref_drug_name=_drug_name_for_fetch,
                        inn_ru=inn_ru,
                    )
                    _mode = _intake_result.get("mode", "")
                    if _mode in ("fasting", "fed", "both"):
                        intake_mode = _mode
                        intake_text_short = {
                            "fasting": "–Ω–∞—Ç–æ—â–∞–∫",
                            "fed": "–ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –ø–∏—â–∏",
                            "both": "–Ω–∞—Ç–æ—â–∞–∫ –∏ –ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≤—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –ø–∏—â–∏",
                        }.get(intake_mode, "–Ω–∞—Ç–æ—â–∞–∫")
                        logger.info(f"‚ÑπÔ∏è –†–µ–∂–∏–º –ø—Ä–∏—ë–º–∞ (Yandex Search) –¥–ª—è {_drug_name_for_fetch}: {_mode}")
                except Exception as e:
                    logger.debug(f"Yandex intake search failed: {e}")

        # ‚îÄ‚îÄ –§–æ—Ä–º–∏—Ä—É–µ–º protocol_title (–ø–æ—Å–ª–µ fetch, –∫–æ–≥–¥–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã –≤—Å–µ –¥–∞–Ω–Ω—ã–µ) ‚îÄ‚îÄ
        # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ‚Äî –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ —Ä—É—Å—Å–∫–∏–π
        ref_mfr = synopsis.get("ref_manufacturer", "")
        if ref_mfr:
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º EN ‚Üí RU –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∞—Ç–∏–Ω–∏—Ü–∞
            _en_to_ru = None
            try:
                from app.utils.inn_utils import ensure_russian_text as _en_to_ru
            except ImportError:
                try:
                    from inn_utils import ensure_russian_text as _en_to_ru
                except ImportError:
                    pass
            if _en_to_ru:
                ref_mfr_ru = _en_to_ru(ref_mfr)
                if ref_mfr_ru != ref_mfr:
                    print(f"  üåê ref_manufacturer: '{ref_mfr}' ‚Üí '{ref_mfr_ru}'")
                    ref_mfr = ref_mfr_ru
                    synopsis["ref_manufacturer"] = ref_mfr
            ref_drug_title = f"{reference_drug_name or ref_drug}, {dosage_form} {dosage} ({ref_mfr})"
        else:
            ref_drug_title = f"{reference_drug_name or ref_drug}, {dosage_form} {dosage}"

        # –ü–æ–ª: "–∂–µ–Ω—Å–∫–æ–≥–æ –ø–æ–ª–∞" —Ç–æ–ª—å–∫–æ –¥–ª—è females_only
        if sex == "females_only":
            sex_title_text = " –∂–µ–Ω—Å–∫–æ–≥–æ –ø–æ–ª–∞"
        else:
            sex_title_text = ""

        synopsis["protocol_title"] = (
            f"–û—Ç–∫—Ä—ã—Ç–æ–µ —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ {design_title_text} –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ "
            f"—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏–∫–∏ –∏ –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ "
            f"–ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ {test_drug_full} –∏ {ref_drug_title} "
            f"—É –∑–¥–æ—Ä–æ–≤—ã—Ö –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–≤{sex_title_text} {intake_text_short}"
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º intake_mode –¥–ª—è docx_exporter
        synopsis["intake_mode"] = intake_mode

        # ‚îÄ‚îÄ –¢–µ–∫—Å—Ç ¬´–î–∏–∑–∞–π–Ω –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è¬ª ‚îÄ‚îÄ
        # –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –∞–±–∑–∞—Ü –ø–æ —ç—Ç–∞–ª–æ–Ω—É iFarma
        hvd_comp_ru = input_data.get("hvd_component_ru", "")
        hvd_comp_en = input_data.get("hvd_component_en", "")
        hvd_cv = input_data.get("hvd_cv_value")
        cv_max = pk.get("cv_intra_max")
        is_hvd = pk.get("is_hvd", False)
        t_half = pk.get("t_half_hours")
        washout_days = design.get("washout_days") or design.get("washout_min_days")

        # –í—ã—á–∏—Å–ª—è–µ–º –æ—Ç–º—ã–≤–æ—á–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∫–∞–∫ 5√óT¬Ω –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if t_half and not washout_days:
            washout_days = max(7, round(5 * t_half / 24) + 1)  # –¥–Ω–µ–π, –º–∏–Ω–∏–º—É–º 7

        study_id = input_data.get("study_id", "")

        if is_hvd and "replicate" in design_type:
            # HVD ‚Üí —Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
            hvd_name = hvd_comp_ru or inn_ru
            cv_text = f"{hvd_cv or cv_max:.0f}%" if (hvd_cv or cv_max) else "–±–æ–ª–µ–µ 30%"

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            if hvd_comp_ru and "+" in inn_ru:
                # –ö–æ–º–±–∏–Ω–∞—Ü–∏—è ‚Äî —É–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç HVD
                component_phrase = (
                    f"–û–¥–∏–Ω –∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏—Å—Å–ª–µ–¥—É–µ–º–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞, {hvd_name}, "
                    f"—è–≤–ª—è–µ—Ç—Å—è –≤—ã—Å–æ–∫–æ–≤–∞—Ä–∏–∞–±–µ–ª—å–Ω—ã–º "
                    f"(–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≤ –ø–ª–∞–∑–º–µ –∫—Ä–æ–≤–∏ (–°max) "
                    f"—Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ {cv_text} [1])."
                )
            else:
                # –û–¥–∏–Ω–æ—á–Ω—ã–π –ú–ù–ù
                component_phrase = (
                    f"–ò—Å—Å–ª–µ–¥—É–µ–º—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Å–æ–∫–æ–≤–∞—Ä–∏–∞–±–µ–ª—å–Ω—ã–º "
                    f"(–≤–Ω—É—Ç—Ä–∏–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –°max "
                    f"—Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ {cv_text} [1])."
                )

            synopsis["study_design_description"] = (
                f"{component_phrase} "
                f"–°–æ–≥–ª–∞—Å–Ω–æ –¥–µ–π—Å—Ç–≤—É—é—â–∏–º –ü—Ä–∞–≤–∏–ª–∞–º –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–≥–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—é–∑–∞ (–ï–ê–≠–°) "
                f"–¥–ª—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —Ñ–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ "
                f"—Å –≤—ã—Å–æ–∫–æ–π –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å—é "
                f"{test_drug_full} –∏ {ref_drug_title} "
                f"–±—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ "
                f"—Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º (—Ä–µ–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–º) –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º "
                f"–≤ {_periods_word} –ø–µ—Ä–∏–æ–¥–∞—Ö –∏ –≤ {_seq_word} –≥—Ä—É–ø–ø–∞—Ö "
                f"—Å –ø—Ä–∏–µ–º–æ–º –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–π –¥–æ–∑—ã. "
                f"–ü—Ä–∏ —ç—Ç–æ–º –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–∏–µ–º–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –±—É–¥—É—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω—ã "
                f"–æ—Ç–º—ã–≤–æ—á–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –Ω–µ –º–µ–Ω–µ–µ –ø—è—Ç–∏ –ø–µ—Ä–∏–æ–¥–æ–≤ "
                f"–ø–æ–ª—É–≤—ã–≤–µ–¥–µ–Ω–∏—è (–¢1/2) –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –≤–µ—â–µ—Å—Ç–≤."
            )
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω
            synopsis["study_design_description"] = (
                f"–î–ª—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —Ñ–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ "
                f"{test_drug_full} –∏ {ref_drug_title} "
                f"–±—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ "
                f"—Å {design_title_text} –¥–∏–∑–∞–π–Ω–æ–º "
                f"—Å –ø—Ä–∏–µ–º–æ–º –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–π –¥–æ–∑—ã. "
                f"–ü—Ä–∏ —ç—Ç–æ–º –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–∏–µ–º–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –±—É–¥—É—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω—ã "
                f"–æ—Ç–º—ã–≤–æ—á–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –Ω–µ –º–µ–Ω–µ–µ –ø—è—Ç–∏ –ø–µ—Ä–∏–æ–¥–æ–≤ "
                f"–ø–æ–ª—É–≤—ã–≤–µ–¥–µ–Ω–∏—è (–¢1/2) –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –≤–µ—â–µ—Å—Ç–≤."
            )

        synopsis["inclusion_criteria"] = _build_inclusion_criteria(
            sex=sex, age_min=age_min, age_max=age_max, inn=inn_ru,
        )
        synopsis["exclusion_criteria"] = _build_exclusion_criteria(
            sex=sex, inn=inn_ru, ref_drug=ref_drug,
        )

        # –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ë–≠
        be_lower = design.get("be_lower", 80.0)
        be_upper = design.get("be_upper", 125.0)
        synopsis["be_criteria"] = (
            f"–í—ã–≤–æ–¥ –æ –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω "
            f"—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–¥—Ö–æ–¥–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞ –æ—Ü–µ–Ω–∫–µ 90% –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö "
            f"–∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å—Ä–µ–¥–Ω–∏—Ö –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π "
            f"–∏—Å—Å–ª–µ–¥—É–µ–º–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ (T) –∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (R) –¥–ª—è "
            f"—Ñ–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ AUC0-t –∏ Cmax {inn_ru}. "
            f"–ü—Ä–µ–ø–∞—Ä–∞—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–º–∏, –µ—Å–ª–∏ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ü–µ–Ω–µ–Ω–Ω—ã—Ö "
            f"–¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è AUC0-t –∏ Cmax –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö "
            f"{be_lower:.2f}-{be_upper:.2f}% (Œ±=0.05) –¥–ª—è –∏–∑—É—á–∞–µ–º–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∞."
        )

        # ‚îÄ‚îÄ –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚îÄ‚îÄ
        # –°–æ–±–∏—Ä–∞–µ–º –∏–∑ PK-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ + –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        sources_list = []
        pk_sources = pk.get("sources", [])
        if isinstance(pk_sources, list):
            for src in pk_sources:
                if isinstance(src, dict):
                    src_type = src.get("source_type", "")
                    title_text = src.get("title", "")
                    pmid = src.get("pmid", "")
                    url = src.get("url", "")
                    doi = src.get("doi", "")
                    parts = []
                    if title_text:
                        parts.append(title_text)
                    if pmid:
                        parts.append(f"PMID: {pmid}")
                    if doi:
                        parts.append(f"DOI: {doi}")
                    if url:
                        parts.append(url)
                    if parts:
                        sources_list.append(". ".join(parts))

        # –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º
        sources_list.extend([
            "–†–µ—à–µ–Ω–∏–µ –°–æ–≤–µ—Ç–∞ –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–π —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –æ—Ç 03.11.2016 ‚Ññ 85 "
            "¬´–û–± —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ü—Ä–∞–≤–∏–ª –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ "
            "–ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–≥–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—é–∑–∞¬ª",
            "–†–µ—à–µ–Ω–∏–µ –°–æ–≤–µ—Ç–∞ –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–π —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –æ—Ç 03.11.2016 ‚Ññ 79 "
            "¬´–û–± —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ü—Ä–∞–≤–∏–ª –ù–∞–¥–ª–µ–∂–∞—â–µ–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ "
            "–ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–≥–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—é–∑–∞¬ª",
            "–ì–û–°–¢ –† 57679-2017 ¬´–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞. "
            "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤¬ª",
        ])

        # –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å, —É–ø–æ–º–∏–Ω–∞–µ–º
        lit_review = pk.get("literature_review", "")
        if lit_review and "–û–•–õ–ü" in lit_review:
            ref_name = pk.get("reference_drug", ref_drug)
            if ref_name and ref_name != "________":
                sources_list.insert(0, f"–û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ (–û–•–õ–ü) {ref_name}")

        synopsis["sources_text"] = "\n".join(
            f"{i+1}. {s}" for i, s in enumerate(sources_list)
        )

        # ‚îÄ‚îÄ –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞: –ø–µ—Ä–µ–≤–æ–¥ EN ‚Üí RU ‚îÄ‚îÄ
        # –í—Å–µ –ø–æ–ª—è —Å–∏–Ω–æ–ø—Å–∏—Å–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ Yandex Translate –ª—é–±—ã–µ –ø–æ–ª—è —Å –ª–∞—Ç–∏–Ω–∏—Ü–µ–π.
        _translate_fn = None
        try:
            from app.utils.inn_utils import ensure_russian_text as _translate_fn
        except ImportError:
            try:
                from inn_utils import ensure_russian_text as _translate_fn
            except ImportError:
                pass

        if _translate_fn:
            # –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
            _fields_to_translate = [
                "ref_manufacturer",
                "manufacturer",
                "manufacturer_country",
                "reference_drug",
                "protocol_title",
                "study_design_description",
            ]
            for fld in _fields_to_translate:
                val = synopsis.get(fld, "")
                if val and isinstance(val, str):
                    translated = _translate_fn(val)
                    if translated != val:
                        print(f"  üåê {fld}: '{val}' ‚Üí '{translated}'")
                        synopsis[fld] = translated

        return AgentResult(data=synopsis, sources=["synopsis_template", "decision_85"])
